<!DOCTYPE html>
<html>
<head>
    <title>Syntax Highlight Test - <%= themeName %></title>
    <style>
        <%- include('partials/styles') %>
    </style>
</head>
<body>
    <h2>Syntax Test: <%= themeName %></h2>
    <pre><code><% 
        let currentLine = 0;
        for (const r of ranges) {
            while (currentLine < r.startLine) {
                %><%= "\n" %><%
                currentLine++;
            }
            const style = `color: ${r.foreground};${r.fontStyle?.includes('italic') ? ' font-style: italic;' : ''}${r.fontStyle?.includes('bold') ? ' font-weight: bold;' : ''}${r.fontStyle?.includes('underline') ? ' text-decoration: underline;' : ''}`;
            
            const sourceAttr = r.source;
            const scopesAttr = r.scopes.join(', ').replace(/"/g, '&quot;');
            const foregroundAttr = r.foreground;
            const scopeColorsAttr = r.scopeColors ? r.scopeColors.join(',') : '';
            const activeIndexAttr = r.activeScopeIndex !== undefined ? r.activeScopeIndex : -1;
            
            const text = r.text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
            
            %><span style="<%= style %>" data-source="<%= sourceAttr %>" data-scopes="<%= scopesAttr %>" data-foreground="<%= foregroundAttr %>" data-scope-colors="<%= scopeColorsAttr %>" data-active-index="<%= activeIndexAttr %>"><%- text %></span><%
        }
    %></code></pre>
    <div id="tooltip"></div>

    <script>
        const tooltip = document.getElementById('tooltip');
        const codeBlock = document.querySelector('pre');

        <%- include('partials/scripts-utils') %>

        codeBlock.addEventListener('mouseover', (e) => {
            if (e.target.tagName === 'SPAN' && e.target.hasAttribute('data-scopes')) {
                const source = e.target.getAttribute('data-source');
                const scopes = e.target.getAttribute('data-scopes');
                const foreground = e.target.getAttribute('data-foreground');
                const scopeColorsStr = e.target.getAttribute('data-scope-colors') || '';
                const activeIndexStr = e.target.getAttribute('data-active-index');
                const activeIndex = activeIndexStr ? parseInt(activeIndexStr, 10) : -1;
                
                const scopeList = scopes.split(',').map(s => s.trim());
                const colorList = scopeColorsStr.split(','); 
                
                let html = '';
                
                // Color Info
                html += '<span class="tooltip-label">Foreground:</span> <span class="tooltip-val" style="display: inline-block; color: #ccc;">';
                html += '<span class="color-swatch" style="background-color: ' + foreground + ';"></span>';
                html += '<span style="vertical-align: middle;">' + foreground + '</span>';
                html += '</span><br>';

                if (source === 'semantic') {
                    // Split into semantic and textmate
                    // We look for our special separator
                    const sepIdx = scopeList.indexOf('__TM_SCOPES__');
                    
                    if (sepIdx !== -1) {
                         const semanticParts = scopeList.slice(0, sepIdx);
                         const semanticColors = colorList.slice(0, sepIdx);
                         
                         const tmParts = scopeList.slice(sepIdx + 1);
                         const tmColors = colorList.slice(sepIdx + 1);
                         
                         // Indices need to account for separation
                         // semantic indices: 0 to sepIdx-1
                         // tm indices: sepIdx+1 to end
                         
                         html += '<span class="tooltip-label">Source:</span> <span class="tooltip-val">' + source + '</span><br>';
                         html += '<span class="tooltip-label">Semantic Token Type:</span> <div class="tooltip-val">';
                         semanticParts.forEach((s, i) => html += renderScope(s, semanticColors[i], i, activeIndex, false));
                         html += '</div><br>';
                         
                         html += '<span class="tooltip-label">TextMate Scopes:</span> <div class="tooltip-val">';
                         // Reverse for display hierarchy
                         // We need the original index to match activeIndex
                         for (let i = tmParts.length - 1; i >= 0; i--) {
                             const originalIndex = sepIdx + 1 + i;
                             html += renderScope(tmParts[i], tmColors[i], originalIndex, activeIndex, true);
                         }
                         html += '</div>';
                    } else {
                         // Fallback
                         html += '<span class="tooltip-label">Source:</span> <span class="tooltip-val">' + source + '</span><br>';
                         html += '<span class="tooltip-label">Scopes:</span> <div class="tooltip-val">';
                         scopeList.forEach((s, i) => html += renderScope(s, colorList[i], i, activeIndex));
                         html += '</div>';
                    }
                } else {
                     // Standard TextMate
                     html += '<span class="tooltip-label">Source:</span> <span class="tooltip-val">' + source + '</span><br>';
                     html += '<span class="tooltip-label">Scopes:</span> <div class="tooltip-val">';
                     for (let i = scopeList.length - 1; i >= 0; i--) {
                         // All are potentially gray except active one
                         html += renderScope(scopeList[i], colorList[i], i, activeIndex, true);
                     }
                     html += '</div>';
                }

                tooltip.innerHTML = html;
                
                tooltip.style.display = 'block';
                updatePosition(e);
            }
        });

        codeBlock.addEventListener('mousemove', (e) => {
             if (tooltip.style.display === 'block') {
                updatePosition(e);
             }
        });

        codeBlock.addEventListener('mouseout', (e) => {
            if (e.target.tagName === 'SPAN' && e.target.hasAttribute('data-scopes')) {
                tooltip.style.display = 'none';
            }
        });
    </script>
</body>
</html>
